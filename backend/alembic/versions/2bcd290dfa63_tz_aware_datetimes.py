"""tz_aware_datetimes

Revision ID: 2bcd290dfa63
Revises: 
Create Date: 2026-02-27 03:01:55.806765

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = '2bcd290dfa63'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.execute("DELETE FROM connected_accounts WHERE provider_user_id IS NULL OR provider_email IS NULL OR scopes IS NULL")
    op.execute("DELETE FROM attachments WHERE filename_sanitized IS NULL OR content_type IS NULL OR sha256_hash IS NULL")
    op.execute("UPDATE workspaces SET plan = 'TEAM' WHERE plan IS NULL")
    op.execute("UPDATE workspaces SET status = 'ACTIVE' WHERE status IS NULL")
    op.execute("DELETE FROM calendar_suggestions WHERE event_type IS NULL OR status IS NULL")
    op.execute("DELETE FROM drafts")
    op.drop_index('idx_translations_key_locale', table_name='translations')
    op.drop_index('idx_admin_audit_action_created', table_name='admin_audit_log')
    op.drop_index('idx_admin_audit_admin_created', table_name='admin_audit_log')
    op.drop_index('idx_admin_audit_target_created', table_name='admin_audit_log')
    op.drop_index('idx_error_logs_severity', table_name='error_logs', postgresql_where="((severity)::text = ANY ((ARRAY['error'::character varying, 'critical'::character varying])::text[]))")
    op.drop_index('idx_error_logs_type_created', table_name='error_logs')
    op.drop_index('idx_error_logs_unresolved', table_name='error_logs', postgresql_where='(resolved = false)')
    op.drop_index('idx_error_logs_user', table_name='error_logs', postgresql_where='(user_id IS NOT NULL)')
    op.drop_index('idx_scheduled_jobs_next_run', table_name='scheduled_jobs', postgresql_where='(is_active = true)')
    op.drop_index('idx_ai_logs_cost', table_name='ai_usage_logs', postgresql_where='(cost_cents > 0)')
    op.drop_index('idx_ai_logs_operation', table_name='ai_usage_logs')
    op.drop_index('idx_ai_logs_user_created', table_name='ai_usage_logs')
    op.drop_index('idx_search_queries_text', table_name='search_queries', postgresql_using='gin')
    op.drop_index('idx_search_queries_user_created', table_name='search_queries')
    op.drop_index('idx_email_rules_user_priority', table_name='email_rules', postgresql_where='(is_active = true)')
    op.drop_index('idx_rule_execution_rule', table_name='rule_execution_log')
    op.drop_index('idx_abuse_reports_assigned', table_name='abuse_reports', postgresql_where="((status)::text = 'investigating'::text)")
    op.drop_index('idx_abuse_reports_reported_user', table_name='abuse_reports')
    op.drop_index('idx_abuse_reports_status', table_name='abuse_reports')
    op.drop_index('idx_gdpr_requests_pending', table_name='gdpr_requests', postgresql_where="((status)::text = 'pending'::text)")
    op.drop_index('idx_gdpr_requests_user_status', table_name='gdpr_requests')
    op.drop_index('idx_jobs_pending', table_name='job_queue', postgresql_where="((status)::text = 'pending'::text)")
    op.drop_index('idx_jobs_reserved_expires', table_name='job_queue', postgresql_where="((status)::text = 'reserved'::text)")
    op.drop_index('idx_jobs_type_status', table_name='job_queue')
    op.drop_index('idx_notifications_expires', table_name='notifications', postgresql_where='(expires_at IS NOT NULL)')
    op.drop_index('idx_notifications_user_unread', table_name='notifications', postgresql_where='(is_read = false)')
    op.drop_index('idx_admin_users_role', table_name='admin_users')
    op.drop_index('idx_admin_users_user', table_name='admin_users', postgresql_where='(is_active = true)')
    op.drop_index('idx_integration_logs_created', table_name='integration_logs')
    op.drop_index('idx_health_checks_component_time', table_name='health_checks')
    op.drop_index('idx_experiment_assignments_experiment', table_name='ab_experiment_assignments')
    op.drop_index('idx_experiment_assignments_user', table_name='ab_experiment_assignments')
    op.drop_index('idx_feature_flags_key', table_name='feature_flags', postgresql_where='(is_active = true)')
    op.drop_index('idx_integrations_user_type', table_name='integrations', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('idx_integrations_workspace', table_name='integrations', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('idx_ai_queue_pending', table_name='ai_processing_queue', postgresql_where="((status)::text = 'pending'::text)")
    op.drop_index('idx_ai_queue_reserved', table_name='ai_processing_queue', postgresql_where="((status)::text = 'reserved'::text)")
    op.drop_index('idx_ai_queue_user_entity', table_name='ai_processing_queue')
    op.drop_index('idx_followups_overdue', table_name='follow_ups', postgresql_where="((status)::text = 'waiting'::text)")
    op.drop_index('idx_followups_thread', table_name='follow_ups', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('idx_followups_user_status', table_name='follow_ups', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('ix_waiting_for_thread_id', table_name='follow_ups')
    op.drop_index('ix_waiting_for_user_id', table_name='follow_ups')
    op.drop_index('idx_rate_violations_ip', table_name='rate_limit_violations')
    op.drop_index('idx_rate_violations_user', table_name='rate_limit_violations')
    op.drop_index('idx_activity_logs_user_created', table_name='user_activity_logs')
    op.drop_index('idx_feature_overrides_user_flag', table_name='user_feature_overrides')
    op.drop_index('idx_saved_searches_user', table_name='saved_searches')
    op.drop_index('idx_templates_user', table_name='email_templates', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('idx_templates_workspace', table_name='email_templates', postgresql_where='((is_public = true) AND (deleted_at IS NULL))')
    op.drop_index('idx_subscriptions_status', table_name='subscriptions')
    op.drop_index('idx_subscriptions_stripe_customer', table_name='subscriptions')
    op.drop_index('idx_subscriptions_user', table_name='subscriptions')
    op.drop_index('idx_user_analytics_date', table_name='user_analytics_daily')
    op.drop_index('idx_consent_user_type', table_name='consent_records')
    op.drop_index('idx_ai_summary_date_op', table_name='ai_usage_daily_summary')
    op.drop_index('idx_ai_summary_date_user', table_name='ai_usage_daily_summary')
    op.drop_index('idx_api_keys_hash', table_name='api_keys')
    op.drop_index('idx_api_keys_user', table_name='api_keys', postgresql_where='(is_active = true)')
    op.drop_index('idx_invoices_status', table_name='invoices')
    op.drop_index('idx_invoices_user_created', table_name='invoices')
    op.drop_index('idx_attachments_email', table_name='attachments', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('idx_attachments_hash', table_name='attachments', postgresql_where='(sha256_hash IS NOT NULL)')
    op.drop_index('idx_attachments_status', table_name='attachments', postgresql_where="((status)::text = ANY ((ARRAY['pending'::character varying, 'processing'::character varying])::text[]))")
    op.drop_index('idx_attachments_user', table_name='attachments', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('ix_attachments_message_id', table_name='attachments')
    op.drop_index('ix_attachments_user_id', table_name='attachments')
    op.drop_index('idx_calendar_date', table_name='calendar_suggestions', postgresql_where="((status)::text = 'suggested'::text)")
    op.drop_index('idx_calendar_thread', table_name='calendar_suggestions', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('idx_calendar_user_status', table_name='calendar_suggestions', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('idx_connected_accounts_status', table_name='connected_accounts')
    op.drop_index('idx_connected_accounts_sync', table_name='connected_accounts', postgresql_where='(sync_enabled = true)')
    op.drop_index('idx_connected_accounts_user_provider', table_name='connected_accounts', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('idx_credit_pricing_active', table_name='credit_pricing', postgresql_where='(is_active = true)')
    op.drop_index('idx_credit_txns_flagged', table_name='credit_transactions', postgresql_where='(is_flagged = true)')
    op.drop_index('idx_credit_txns_operation', table_name='credit_transactions', postgresql_where='(operation_type IS NOT NULL)')
    op.drop_index('idx_credit_txns_type', table_name='credit_transactions')
    op.drop_index('idx_credit_txns_user_created', table_name='credit_transactions')
    op.drop_index('idx_drafts_status', table_name='drafts')
    op.drop_index('idx_drafts_user_thread', table_name='drafts', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('idx_emails_thread', table_name='emails')
    op.drop_index('idx_emails_user_received', table_name='emails', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('idx_oauth_state_token', table_name='oauth_state_tokens', postgresql_where='(consumed = false)')
    op.drop_index('idx_tasks_source_thread', table_name='tasks', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('idx_tasks_user_status_due', table_name='tasks', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('ix_tasks_thread_id', table_name='tasks')
    op.drop_index('idx_threads_intel_pending', table_name='threads', postgresql_where="((intel_status)::text = 'pending'::text)")
    op.drop_index('idx_threads_user_updated', table_name='threads', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('idx_user_credits_balance', table_name='user_credits', postgresql_where='(credits_balance > 0)')
    op.drop_index('idx_user_credits_user', table_name='user_credits')
    op.drop_index('idx_security_events_severity', table_name='user_security_events', postgresql_where="((severity)::text = ANY ((ARRAY['warning'::character varying, 'critical'::character varying])::text[]))")
    op.drop_index('idx_security_events_type', table_name='user_security_events')
    op.drop_index('idx_security_events_user_time', table_name='user_security_events')
    op.drop_index('idx_sessions_token', table_name='user_sessions')
    op.drop_index('idx_sessions_user', table_name='user_sessions', postgresql_where='(is_revoked = false)')
    op.drop_index('idx_users_workspace', table_name='users', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('idx_vector_docs_chroma_id', table_name='vector_documents')
    op.drop_index('idx_vector_docs_user_source', table_name='vector_documents', postgresql_where='(deleted_at IS NULL)')
    op.drop_index('idx_workspaces_owner', table_name='workspaces')
    op.drop_index('idx_workspaces_slug', table_name='workspaces', postgresql_where='(deleted_at IS NULL)')
    op.execute('DROP TABLE IF EXISTS translations CASCADE')
    op.execute('DROP TABLE IF EXISTS admin_audit_log CASCADE')
    op.execute('DROP TABLE IF EXISTS error_logs CASCADE')
    op.execute('DROP TABLE IF EXISTS notification_preferences CASCADE')
    op.execute('DROP TABLE IF EXISTS system_analytics_daily CASCADE')
    op.execute('DROP TABLE IF EXISTS scheduled_jobs CASCADE')
    op.execute('DROP TABLE IF EXISTS ai_usage_logs CASCADE')
    op.execute('DROP TABLE IF EXISTS search_queries CASCADE')
    op.execute('DROP TABLE IF EXISTS email_rules CASCADE')
    op.execute('DROP TABLE IF EXISTS rule_execution_log CASCADE')
    op.execute('DROP TABLE IF EXISTS ab_experiments CASCADE')
    op.execute('DROP TABLE IF EXISTS abuse_reports CASCADE')
    op.execute('DROP TABLE IF EXISTS gdpr_requests CASCADE')
    op.execute('DROP TABLE IF EXISTS job_queue CASCADE')
    op.execute('DROP TABLE IF EXISTS notifications CASCADE')
    op.execute('DROP TABLE IF EXISTS admin_users CASCADE')
    op.execute('DROP TABLE IF EXISTS integration_logs CASCADE')
    op.execute('DROP TABLE IF EXISTS health_checks CASCADE')
    op.execute('DROP TABLE IF EXISTS ab_experiment_assignments CASCADE')
    op.execute('DROP TABLE IF EXISTS feature_flags CASCADE')
    op.execute('DROP TABLE IF EXISTS data_retention_policies CASCADE')
    op.execute('DROP TABLE IF EXISTS integrations CASCADE')
    op.execute('DROP TABLE IF EXISTS ai_processing_queue CASCADE')
    op.execute('DROP TABLE IF EXISTS follow_ups CASCADE')
    op.execute('DROP TABLE IF EXISTS rate_limit_violations CASCADE')
    op.execute('DROP TABLE IF EXISTS user_activity_logs CASCADE')
    op.execute('DROP TABLE IF EXISTS user_feature_overrides CASCADE')
    op.execute('DROP TABLE IF EXISTS saved_searches CASCADE')
    op.execute('DROP TABLE IF EXISTS email_templates CASCADE')
    op.execute('DROP TABLE IF EXISTS subscriptions CASCADE')
    op.execute('DROP TABLE IF EXISTS user_analytics_daily CASCADE')
    op.execute('DROP TABLE IF EXISTS consent_records CASCADE')
    op.execute('DROP TABLE IF EXISTS ai_usage_daily_summary CASCADE')
    op.execute('DROP TABLE IF EXISTS api_keys CASCADE')
    op.execute('DROP TABLE IF EXISTS invoices CASCADE')
    op.alter_column('attachments', 'filename_sanitized',
               existing_type=sa.VARCHAR(),
               nullable=False)
    op.alter_column('attachments', 'content_type',
               existing_type=sa.VARCHAR(),
               nullable=False)
    op.alter_column('attachments', 'size_bytes',
               existing_type=sa.INTEGER(),
               type_=sa.BigInteger(),
               nullable=False)
    op.alter_column('attachments', 'sha256_hash',
               existing_type=sa.VARCHAR(),
               nullable=False)
    op.execute("ALTER TABLE attachments ALTER COLUMN storage_provider DROP DEFAULT")
    op.alter_column('attachments', 'storage_provider',
               existing_type=sa.VARCHAR(),
               type_=sa.Enum('S3', 'R2', 'GCS', name='storageprovider'),
               postgresql_using='"storage_provider"::text::storageprovider', nullable=False)
    op.alter_column('attachments', 'storage_path',
               existing_type=sa.VARCHAR(),
               type_=sa.Text(),
               existing_nullable=True)
    op.execute("ALTER TABLE attachments ALTER COLUMN status DROP DEFAULT")
    op.alter_column('attachments', 'status',
               existing_type=sa.VARCHAR(),
               type_=sa.Enum('PENDING', 'DOWNLOADING', 'PROCESSING', 'INDEXED', 'FAILED', 'SKIPPED', 'QUARANTINED', name='attachmentstatus'),
               postgresql_using='"status"::text::attachmentstatus', nullable=False)
    op.alter_column('attachments', 'extraction_confidence',
               existing_type=sa.INTEGER(),
               type_=sa.Float(),
               existing_nullable=True)
    op.alter_column('attachments', 'downloaded_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('attachments', 'processed_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('attachments', 'deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('attachments', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('attachments', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.create_index(op.f('ix_attachments_email_id'), 'attachments', ['email_id'], unique=False)
    op.create_index(op.f('ix_attachments_sha256_hash'), 'attachments', ['sha256_hash'], unique=False)
    op.create_unique_constraint('unique_email_attachment_hash', 'attachments', ['email_id', 'sha256_hash'])
    op.drop_constraint('attachments_user_id_fkey', 'attachments', type_='foreignkey')
    op.drop_constraint('attachments_message_id_fkey', 'attachments', type_='foreignkey')
    op.create_foreign_key(None, 'attachments', 'emails', ['email_id'], ['id'], ondelete='CASCADE')
    op.drop_column('attachments', 'user_id')
    op.drop_column('attachments', 'document_type')
    op.drop_column('attachments', 'key_points')
    op.drop_column('attachments', 'original_filename')
    op.drop_column('attachments', 'mime_type')
    op.drop_column('attachments', 'summary')
    op.add_column('calendar_suggestions', sa.Column('is_recurring', sa.Boolean(), nullable=True))
    op.alter_column('calendar_suggestions', 'email_id',
               existing_type=sa.VARCHAR(),
               nullable=False)
    op.alter_column('calendar_suggestions', 'event_type',
               existing_type=sa.VARCHAR(),
               nullable=False,
               existing_server_default=sa.text("'meeting'::character varying"))
    op.alter_column('calendar_suggestions', 'suggested_time',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('calendar_suggestions', 'suggested_end_time',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('calendar_suggestions', 'participants',
               existing_type=postgresql.ARRAY(sa.TEXT()),
               type_=postgresql.ARRAY(sa.String()),
               existing_nullable=True,
               existing_server_default=sa.text("'{}'::text[]"))
    op.alter_column('calendar_suggestions', 'confidence_score',
               existing_type=sa.INTEGER(),
               nullable=False,
               existing_server_default=sa.text('0'))
    op.execute("ALTER TABLE calendar_suggestions ALTER COLUMN status DROP DEFAULT")
    op.alter_column('calendar_suggestions', 'status',
               existing_type=sa.VARCHAR(),
               type_=sa.Enum('SUGGESTED', 'ACCEPTED', 'DISMISSED', 'EXPIRED', name='calendarsuggestionstatus'),
               postgresql_using='"status"::text::calendarsuggestionstatus', nullable=False)
    op.alter_column('calendar_suggestions', 'accepted_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('calendar_suggestions', 'dismissed_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('calendar_suggestions', 'deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('calendar_suggestions', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('calendar_suggestions', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.create_index(op.f('ix_calendar_suggestions_email_id'), 'calendar_suggestions', ['email_id'], unique=False)
    op.create_foreign_key(None, 'calendar_suggestions', 'emails', ['email_id'], ['id'])
    op.drop_column('calendar_suggestions', 'is_accepted')
    op.drop_column('calendar_suggestions', 'extracted_from')
    op.execute("ALTER TABLE connected_accounts ALTER COLUMN provider DROP DEFAULT")
    op.alter_column('connected_accounts', 'provider',
               existing_type=postgresql.ENUM('GMAIL', 'OUTLOOK', name='providertype'),
               type_=sa.Enum('GMAIL', 'OUTLOOK', name='providertype', native_enum=False, length=50),
               existing_postgresql_using='"provider"::text::providertype', nullable=False)
    op.alter_column('connected_accounts', 'provider_user_id',
               existing_type=sa.VARCHAR(),
               nullable=False)
    op.alter_column('connected_accounts', 'provider_email',
               existing_type=sa.VARCHAR(),
               nullable=False)
    op.alter_column('connected_accounts', 'token_expires_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('connected_accounts', 'scopes',
               existing_type=sa.VARCHAR(),
               nullable=False)
    op.alter_column('connected_accounts', 'status',
               existing_type=sa.VARCHAR(),
               nullable=False,
               existing_server_default=sa.text("'active'::character varying"))
    op.alter_column('connected_accounts', 'last_sync_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('connected_accounts', 'sync_status',
               existing_type=sa.VARCHAR(),
               nullable=False)
    op.alter_column('connected_accounts', 'last_watch_expires_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('connected_accounts', 'deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('connected_accounts', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('connected_accounts', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.create_unique_constraint('unique_user_provider_deleted', 'connected_accounts', ['user_id', 'provider', 'deleted_at'])
    op.add_column('credit_packages', sa.Column('description', sa.Text(), nullable=True))
    op.add_column('credit_packages', sa.Column('created_at', sa.DateTime(timezone=True), nullable=True))
    op.add_column('credit_packages', sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True))
    op.alter_column('credit_pricing', 'description',
               existing_type=sa.VARCHAR(),
               type_=sa.Text(),
               existing_nullable=True)
    op.alter_column('credit_pricing', 'effective_from',
               existing_type=sa.DATE(),
               nullable=False)
    op.alter_column('credit_pricing', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('credit_pricing', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('credit_transactions', 'status',
               existing_type=postgresql.ENUM('COMPLETED', 'RESERVED', 'CANCELLED', name='transactionstatus'),
               nullable=False)
    op.alter_column('credit_transactions', 'expires_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('credit_transactions', 'user_agent',
               existing_type=sa.VARCHAR(),
               type_=sa.Text(),
               existing_nullable=True)
    op.alter_column('credit_transactions', 'flag_reason',
               existing_type=sa.VARCHAR(),
               type_=sa.Text(),
               existing_nullable=True)
    op.alter_column('credit_transactions', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('credit_usage_daily', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('documents', 'indexed_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.add_column('drafts', sa.Column('subject', sa.String(), nullable=False))
    op.add_column('drafts', sa.Column('body', sa.Text(), nullable=False))
    op.add_column('drafts', sa.Column('user_edited', sa.Boolean(), nullable=True))
    op.execute("ALTER TABLE drafts ALTER COLUMN tone DROP DEFAULT")
    op.alter_column('drafts', 'tone',
               existing_type=postgresql.ENUM('BRIEF', 'NORMAL', 'FORMAL', name='tonetype'),
               type_=sa.Enum('PROFESSIONAL', 'FRIENDLY', 'CONCISE', 'FORMAL', 'ASSERTIVE', 'CUSTOM', name='drafttone'),
               postgresql_using='"tone"::text::drafttone', nullable=False)
    op.alter_column('drafts', 'generation_model',
               existing_type=sa.VARCHAR(),
               nullable=False)
    op.execute("ALTER TABLE drafts ALTER COLUMN status DROP DEFAULT")
    op.alter_column('drafts', 'status',
               existing_type=sa.VARCHAR(),
               type_=sa.Enum('GENERATED', 'EDITED', 'SENT', 'DISCARDED', name='draftstatus'),
               postgresql_using='"status"::text::draftstatus', nullable=False)
    op.alter_column('drafts', 'copied_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('drafts', 'sent_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.execute("ALTER TABLE drafts ALTER COLUMN feedback DROP DEFAULT")
    op.alter_column('drafts', 'feedback',
               existing_type=sa.VARCHAR(),
               type_=sa.Enum('THUMBS_UP', 'THUMBS_DOWN', 'NEUTRAL', name='draftfeedback'),
               existing_postgresql_using='"feedback"::text::draftfeedback', nullable=True)
    op.alter_column('drafts', 'deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('drafts', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('drafts', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.create_foreign_key(None, 'drafts', 'emails', ['reply_to_email_id'], ['id'])
    op.drop_column('drafts', 'model_version')
    op.drop_column('drafts', 'content')
    op.drop_column('drafts', 'references_attachments')
    op.drop_column('drafts', 'references_deadlines')
    op.drop_column('drafts', 'placeholders_json')
    op.drop_column('drafts', 'has_unresolved_placeholders')
    op.drop_column('drafts', 'is_sent')
    op.alter_column('emails', 'sender',
               existing_type=sa.VARCHAR(),
               nullable=False)
    op.alter_column('emails', 'recipients',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=False)
    op.alter_column('emails', 'subject',
               existing_type=sa.VARCHAR(),
               nullable=False)
    op.alter_column('emails', 'snippet',
               existing_type=sa.TEXT(),
               type_=sa.String(),
               existing_nullable=True)
    op.alter_column('emails', 'references',
               existing_type=postgresql.ARRAY(sa.TEXT()),
               type_=postgresql.ARRAY(sa.String()),
               existing_nullable=True)
    op.alter_column('emails', 'received_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               nullable=False)
    op.alter_column('emails', 'sent_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               nullable=True)
    op.alter_column('emails', 'deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('emails', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('emails', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.create_index(op.f('ix_emails_external_id'), 'emails', ['external_id'], unique=False)
    op.create_index(op.f('ix_emails_received_at'), 'emails', ['received_at'], unique=False)
    op.create_index(op.f('ix_emails_sender'), 'emails', ['sender'], unique=False)
    op.drop_column('emails', 'cc_addresses')
    op.drop_column('emails', 'is_starred')
    op.drop_column('emails', 'is_read')
    op.drop_column('emails', 'from_address')
    op.drop_column('emails', 'to_addresses')
    op.drop_column('emails', 'body_text')
    op.alter_column('messages', 'sent_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=False)
    op.alter_column('messages', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.execute("ALTER TABLE oauth_state_tokens ALTER COLUMN provider DROP DEFAULT")
    op.alter_column('oauth_state_tokens', 'provider',
               existing_type=sa.VARCHAR(),
               type_=sa.Enum('GMAIL', 'OUTLOOK', name='providertype'),
               existing_postgresql_using='"provider"::text::providertype', nullable=False)
    op.alter_column('oauth_state_tokens', 'expires_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=False)
    op.alter_column('oauth_state_tokens', 'consumed_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('oauth_state_tokens', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.drop_constraint('oauth_state_tokens_state_token_key', 'oauth_state_tokens', type_='unique')
    op.create_index(op.f('ix_oauth_state_tokens_state_token'), 'oauth_state_tokens', ['state_token'], unique=True)
    op.alter_column('reminders', 'remind_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=False)
    op.alter_column('reminders', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('tasks', 'source_thread_id',
               existing_type=sa.VARCHAR(),
               nullable=True)
    op.execute("ALTER TABLE tasks ALTER COLUMN status DROP DEFAULT")
    op.alter_column('tasks', 'status',
               existing_type=postgresql.ENUM('PENDING', 'IN_PROGRESS', 'COMPLETED', 'DISMISSED', name='taskstatus'),
               type_=sa.Enum('PENDING', 'TODO', 'IN_PROGRESS', 'DONE', 'CANCELLED', name='taskstatus', native_enum=False, length=50),
               postgresql_using='"status"::text::taskstatus', nullable=False)
    op.execute("ALTER TABLE tasks ALTER COLUMN task_type DROP DEFAULT")
    op.alter_column('tasks', 'task_type',
               existing_type=postgresql.ENUM('REPLY', 'SCHEDULE', 'REVIEW', 'FOLLOWUP', name='tasktype'),
               type_=sa.Enum('GENERAL', 'EMAIL', 'FOLLOW_UP', 'MEETING', name='tasktype', native_enum=False, length=50),
               existing_postgresql_using='"task_type"::text::tasktype', nullable=False)
    op.alter_column('tasks', 'due_time',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('tasks', 'reminder_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('tasks', 'completed_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('tasks', 'tags',
               existing_type=postgresql.ARRAY(sa.TEXT()),
               type_=postgresql.ARRAY(sa.String()),
               existing_nullable=True,
               existing_server_default=sa.text("'{}'::text[]"))
    op.alter_column('tasks', 'deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('tasks', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('tasks', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.create_index(op.f('ix_tasks_source_thread_id'), 'tasks', ['source_thread_id'], unique=False)
    op.create_foreign_key(None, 'tasks', 'workspaces', ['workspace_id'], ['id'])
    op.create_foreign_key(None, 'tasks', 'emails', ['source_email_id'], ['id'])
    op.create_foreign_key(None, 'tasks', 'users', ['assigned_to_user_id'], ['id'])
    op.drop_column('tasks', 'priority_explanation')
    op.drop_column('tasks', 'deadline')
    op.drop_column('tasks', 'effort')
    op.drop_column('tasks', 'priority')
    op.drop_column('tasks', 'deadline_source')
    op.alter_column('threads', 'last_email_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('threads', 'last_synced_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('threads', 'intel_generated_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('threads', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.drop_column('threads', 'intel_error')
    op.drop_column('threads', 'is_archived')
    op.drop_column('threads', 'priority_score')
    op.drop_column('threads', 'summary_model')
    op.drop_column('threads', 'entities_extracted')
    op.drop_column('threads', 'deleted_at')
    op.drop_column('threads', 'first_email_at')
    op.drop_column('threads', 'content_hash')
    op.drop_column('threads', 'intel_completed_at')
    op.drop_column('threads', 'intel_status')
    op.drop_column('threads', 'connected_account_id')
    op.drop_column('threads', 'is_important')
    op.drop_column('threads', 'updated_at')
    op.drop_column('threads', 'sentiment')
    op.drop_column('threads', 'intel_attempts')
    op.drop_column('threads', 'summary_cost_cents')
    op.drop_column('threads', 'priority_level')
    op.drop_column('threads', 'message_count')
    op.drop_column('threads', 'is_read')
    op.drop_column('threads', 'metadata_json')
    op.drop_column('threads', 'summary_tokens_used')
    op.drop_column('threads', 'action_items')
    op.alter_column('user_credit_limits', 'allowed_operations',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=postgresql.ARRAY(sa.String()),
               existing_nullable=True)
    op.alter_column('user_credit_limits', 'blocked_operations',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               type_=postgresql.ARRAY(sa.String()),
               existing_nullable=True)
    op.alter_column('user_credit_limits', 'reason',
               existing_type=sa.VARCHAR(),
               type_=sa.Text(),
               existing_nullable=True)
    op.alter_column('user_credit_limits', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('user_credit_limits', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('user_credits', 'plan',
               existing_type=postgresql.ENUM('FREE', 'PRO', 'TEAM', 'ENTERPRISE', name='plantype'),
               nullable=False)
    op.alter_column('user_credits', 'monthly_credits_allowance',
               existing_type=sa.INTEGER(),
               nullable=False)
    op.alter_column('user_credits', 'billing_cycle_start',
               existing_type=sa.DATE(),
               nullable=False)
    op.alter_column('user_credits', 'credits_expire_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.execute("ALTER TABLE user_credits ALTER COLUMN previous_plan DROP DEFAULT")
    op.alter_column('user_credits', 'previous_plan',
               existing_type=sa.VARCHAR(),
               type_=sa.Enum('FREE', 'PRO', 'TEAM', 'ENTERPRISE', name='plantype'),
               existing_postgresql_using='"previous_plan"::text::plantype', nullable=True)
    op.alter_column('user_credits', 'plan_changed_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('user_credits', 'last_operation_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('user_credits', 'balance_updated_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               nullable=False)
    op.alter_column('user_credits', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('user_credits', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.execute("ALTER TABLE user_security_events ALTER COLUMN event_type DROP DEFAULT")
    op.alter_column('user_security_events', 'event_type',
               existing_type=sa.VARCHAR(),
               type_=sa.Enum('LOGIN_SUCCESS', 'LOGIN_FAILED', 'LOGOUT', 'PASSWORD_CHANGED', 'EMAIL_CHANGED', 'TWO_FACTOR_ENABLED', 'TWO_FACTOR_DISABLED', 'OAUTH_CONNECTED', 'OAUTH_DISCONNECTED', 'SESSION_REVOKED', 'SUSPICIOUS_ACTIVITY', name='securityeventtype'),
               existing_postgresql_using='"event_type"::text::securityeventtype', nullable=False)
    op.execute("ALTER TABLE user_security_events ALTER COLUMN severity DROP DEFAULT")
    op.alter_column('user_security_events', 'severity',
               existing_type=sa.VARCHAR(),
               type_=sa.Enum('INFO', 'WARNING', 'CRITICAL', name='securityseverity'),
               postgresql_using='"severity"::text::securityseverity', nullable=False)
    op.alter_column('user_security_events', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.create_index(op.f('ix_user_security_events_user_id'), 'user_security_events', ['user_id'], unique=False)
    op.alter_column('user_sessions', 'expires_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=False)
    op.alter_column('user_sessions', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.drop_constraint('user_sessions_token_hash_key', 'user_sessions', type_='unique')
    op.create_index(op.f('ix_user_sessions_token_hash'), 'user_sessions', ['token_hash'], unique=True)
    op.create_index(op.f('ix_user_sessions_user_id'), 'user_sessions', ['user_id'], unique=False)
    op.alter_column('users', 'token_expires_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.execute("ALTER TABLE users ALTER COLUMN status DROP DEFAULT")
    op.alter_column('users', 'status',
               existing_type=sa.VARCHAR(),
               type_=sa.Enum('ACTIVE', 'SUSPENDED', 'DELETED', 'PENDING_VERIFICATION', name='user_status'),
               postgresql_using='"status"::text::user_status', nullable=False)
    op.execute("ALTER TABLE users ALTER COLUMN account_type DROP DEFAULT")
    op.alter_column('users', 'account_type',
               existing_type=sa.VARCHAR(),
               type_=sa.Enum('INDIVIDUAL', 'TEAM_MEMBER', 'TEAM_ADMIN', 'ENTERPRISE', name='account_type'),
               postgresql_using='"account_type"::text::account_type', nullable=False)
    op.alter_column('users', 'last_login_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('users', 'deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('users', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('users', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.drop_column('users', 'last_sync')
    op.drop_column('users', 'settings')
    op.drop_column('users', 'is_active')
    op.execute("ALTER TABLE vector_documents ALTER COLUMN source_type DROP DEFAULT")
    op.alter_column('vector_documents', 'source_type',
               existing_type=sa.VARCHAR(),
               type_=sa.Enum('EMAIL_BODY', 'ATTACHMENT', 'SUMMARY', 'TASK_DESCRIPTION', name='vectorsourcetype'),
               existing_postgresql_using='"source_type"::text::vectorsourcetype', nullable=False)
    op.alter_column('vector_documents', 'indexed_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=False)
    op.alter_column('vector_documents', 'deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('vector_documents', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.create_index(op.f('ix_vector_documents_source_id'), 'vector_documents', ['source_id'], unique=False)
    op.create_index(op.f('ix_vector_documents_user_id'), 'vector_documents', ['user_id'], unique=False)
    op.create_unique_constraint('unique_document_chunk', 'vector_documents', ['source_id', 'chunk_index'])
    op.drop_constraint('vector_documents_user_id_fkey', 'vector_documents', type_='foreignkey')
    op.create_foreign_key(None, 'vector_documents', 'users', ['user_id'], ['id'], ondelete='CASCADE')
    op.alter_column('vip_domains', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.execute("ALTER TABLE workspaces ALTER COLUMN plan DROP DEFAULT")
    op.alter_column('workspaces', 'plan',
               existing_type=sa.VARCHAR(),
               type_=sa.Enum('TEAM', 'ENTERPRISE', name='workspaceplan'),
               postgresql_using='"plan"::text::workspaceplan', nullable=False)
    op.execute("ALTER TABLE workspaces ALTER COLUMN status DROP DEFAULT")
    op.alter_column('workspaces', 'status',
               existing_type=sa.VARCHAR(),
               type_=sa.Enum('ACTIVE', 'SUSPENDED', 'DELETED', name='workspacestatus'),
               postgresql_using='"status"::text::workspacestatus', nullable=False)
    op.alter_column('workspaces', 'deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True)
    op.alter_column('workspaces', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('workspaces', 'updated_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.drop_constraint('workspaces_slug_key', 'workspaces', type_='unique')
    op.create_index(op.f('ix_workspaces_slug'), 'workspaces', ['slug'], unique=True)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_workspaces_slug'), table_name='workspaces')
    op.create_unique_constraint('workspaces_slug_key', 'workspaces', ['slug'])
    op.create_index('idx_workspaces_slug', 'workspaces', ['slug'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_workspaces_owner', 'workspaces', ['owner_id'], unique=False)
    op.alter_column('workspaces', 'updated_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('workspaces', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('workspaces', 'deleted_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('workspaces', 'status',
               existing_type=sa.Enum('ACTIVE', 'SUSPENDED', 'DELETED', name='workspacestatus'),
               type_=sa.VARCHAR(),
               nullable=True,
               existing_server_default=sa.text("'active'::character varying"))
    op.alter_column('workspaces', 'plan',
               existing_type=sa.Enum('TEAM', 'ENTERPRISE', name='workspaceplan'),
               type_=sa.VARCHAR(),
               nullable=True,
               existing_server_default=sa.text("'team'::character varying"))
    op.alter_column('vip_domains', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.drop_constraint(None, 'vector_documents', type_='foreignkey')
    op.create_foreign_key('vector_documents_user_id_fkey', 'vector_documents', 'users', ['user_id'], ['id'])
    op.drop_constraint('unique_document_chunk', 'vector_documents', type_='unique')
    op.drop_index(op.f('ix_vector_documents_user_id'), table_name='vector_documents')
    op.drop_index(op.f('ix_vector_documents_source_id'), table_name='vector_documents')
    op.create_index('idx_vector_docs_user_source', 'vector_documents', ['user_id', 'source_type', 'source_id'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_vector_docs_chroma_id', 'vector_documents', ['vector_db_id'], unique=False)
    op.alter_column('vector_documents', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('vector_documents', 'deleted_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('vector_documents', 'indexed_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=False)
    op.alter_column('vector_documents', 'source_type',
               existing_type=sa.Enum('EMAIL_BODY', 'ATTACHMENT', 'SUMMARY', 'TASK_DESCRIPTION', name='vectorsourcetype'),
               type_=sa.VARCHAR(),
               existing_nullable=False)
    op.add_column('users', sa.Column('is_active', sa.BOOLEAN(), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('settings', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=True))
    op.add_column('users', sa.Column('last_sync', postgresql.TIMESTAMP(), autoincrement=False, nullable=True))
    op.create_index('idx_users_workspace', 'users', ['workspace_id'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.alter_column('users', 'updated_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('users', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('users', 'deleted_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('users', 'last_login_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('users', 'account_type',
               existing_type=sa.Enum('INDIVIDUAL', 'TEAM_MEMBER', 'TEAM_ADMIN', 'ENTERPRISE', name='account_type'),
               type_=sa.VARCHAR(),
               nullable=True,
               existing_server_default=sa.text("'individual'::character varying"))
    op.alter_column('users', 'status',
               existing_type=sa.Enum('ACTIVE', 'SUSPENDED', 'DELETED', 'PENDING_VERIFICATION', name='user_status'),
               type_=sa.VARCHAR(),
               nullable=True,
               existing_server_default=sa.text("'active'::character varying"))
    op.alter_column('users', 'token_expires_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.drop_index(op.f('ix_user_sessions_user_id'), table_name='user_sessions')
    op.drop_index(op.f('ix_user_sessions_token_hash'), table_name='user_sessions')
    op.create_unique_constraint('user_sessions_token_hash_key', 'user_sessions', ['token_hash'])
    op.create_index('idx_sessions_user', 'user_sessions', ['user_id'], unique=False, postgresql_where='(is_revoked = false)')
    op.create_index('idx_sessions_token', 'user_sessions', ['token_hash'], unique=False)
    op.alter_column('user_sessions', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('user_sessions', 'expires_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=False)
    op.drop_index(op.f('ix_user_security_events_user_id'), table_name='user_security_events')
    op.create_index('idx_security_events_user_time', 'user_security_events', ['user_id', sa.text('created_at DESC')], unique=False)
    op.create_index('idx_security_events_type', 'user_security_events', ['event_type'], unique=False)
    op.create_index('idx_security_events_severity', 'user_security_events', ['severity'], unique=False, postgresql_where="((severity)::text = ANY ((ARRAY['warning'::character varying, 'critical'::character varying])::text[]))")
    op.alter_column('user_security_events', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('user_security_events', 'severity',
               existing_type=sa.Enum('INFO', 'WARNING', 'CRITICAL', name='securityseverity'),
               type_=sa.VARCHAR(),
               nullable=True,
               existing_server_default=sa.text("'info'::character varying"))
    op.alter_column('user_security_events', 'event_type',
               existing_type=sa.Enum('LOGIN_SUCCESS', 'LOGIN_FAILED', 'LOGOUT', 'PASSWORD_CHANGED', 'EMAIL_CHANGED', 'TWO_FACTOR_ENABLED', 'TWO_FACTOR_DISABLED', 'OAUTH_CONNECTED', 'OAUTH_DISCONNECTED', 'SESSION_REVOKED', 'SUSPICIOUS_ACTIVITY', name='securityeventtype'),
               type_=sa.VARCHAR(),
               existing_nullable=False)
    op.create_index('idx_user_credits_user', 'user_credits', ['user_id'], unique=False)
    op.create_index('idx_user_credits_balance', 'user_credits', ['credits_balance'], unique=False, postgresql_where='(credits_balance > 0)')
    op.alter_column('user_credits', 'updated_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('user_credits', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('user_credits', 'balance_updated_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               nullable=True)
    op.alter_column('user_credits', 'last_operation_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('user_credits', 'plan_changed_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('user_credits', 'previous_plan',
               existing_type=sa.Enum('FREE', 'PRO', 'TEAM', 'ENTERPRISE', name='plantype'),
               type_=sa.VARCHAR(),
               existing_nullable=True)
    op.alter_column('user_credits', 'credits_expire_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('user_credits', 'billing_cycle_start',
               existing_type=sa.DATE(),
               nullable=True)
    op.alter_column('user_credits', 'monthly_credits_allowance',
               existing_type=sa.INTEGER(),
               nullable=True)
    op.alter_column('user_credits', 'plan',
               existing_type=postgresql.ENUM('FREE', 'PRO', 'TEAM', 'ENTERPRISE', name='plantype'),
               nullable=True)
    op.alter_column('user_credit_limits', 'updated_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('user_credit_limits', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('user_credit_limits', 'reason',
               existing_type=sa.Text(),
               type_=sa.VARCHAR(),
               existing_nullable=True)
    op.alter_column('user_credit_limits', 'blocked_operations',
               existing_type=postgresql.ARRAY(sa.String()),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.alter_column('user_credit_limits', 'allowed_operations',
               existing_type=postgresql.ARRAY(sa.String()),
               type_=postgresql.JSONB(astext_type=sa.Text()),
               existing_nullable=True)
    op.add_column('threads', sa.Column('action_items', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'[]'::jsonb"), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('summary_tokens_used', sa.INTEGER(), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('metadata_json', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('is_read', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('message_count', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('priority_level', sa.VARCHAR(), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('summary_cost_cents', sa.INTEGER(), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('intel_attempts', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('sentiment', sa.VARCHAR(), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('is_important', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('connected_account_id', sa.VARCHAR(), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('intel_status', sa.VARCHAR(), server_default=sa.text("'pending'::character varying"), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('intel_completed_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('content_hash', sa.VARCHAR(), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('first_email_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('deleted_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('entities_extracted', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('summary_model', sa.VARCHAR(), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('priority_score', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('is_archived', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True))
    op.add_column('threads', sa.Column('intel_error', sa.VARCHAR(), autoincrement=False, nullable=True))
    op.create_index('idx_threads_user_updated', 'threads', ['user_id', sa.text('last_email_at DESC')], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_threads_intel_pending', 'threads', ['id'], unique=False, postgresql_where="((intel_status)::text = 'pending'::text)")
    op.alter_column('threads', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('threads', 'intel_generated_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('threads', 'last_synced_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('threads', 'last_email_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.add_column('tasks', sa.Column('deadline_source', sa.VARCHAR(), autoincrement=False, nullable=True))
    op.add_column('tasks', sa.Column('priority', postgresql.ENUM('DO_NOW', 'DO_TODAY', 'CAN_WAIT', name='prioritylevel'), autoincrement=False, nullable=True))
    op.add_column('tasks', sa.Column('effort', postgresql.ENUM('QUICK', 'DEEP_WORK', name='effortlevel'), autoincrement=False, nullable=True))
    op.add_column('tasks', sa.Column('deadline', postgresql.TIMESTAMP(), autoincrement=False, nullable=True))
    op.add_column('tasks', sa.Column('priority_explanation', sa.TEXT(), autoincrement=False, nullable=True))
    op.drop_constraint(None, 'tasks', type_='foreignkey')
    op.drop_constraint(None, 'tasks', type_='foreignkey')
    op.drop_constraint(None, 'tasks', type_='foreignkey')
    op.drop_index(op.f('ix_tasks_source_thread_id'), table_name='tasks')
    op.create_index('ix_tasks_thread_id', 'tasks', ['source_thread_id'], unique=False)
    op.create_index('idx_tasks_user_status_due', 'tasks', ['user_id', 'status', 'due_date'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_tasks_source_thread', 'tasks', ['source_thread_id'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.alter_column('tasks', 'updated_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('tasks', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('tasks', 'deleted_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('tasks', 'tags',
               existing_type=postgresql.ARRAY(sa.String()),
               type_=postgresql.ARRAY(sa.TEXT()),
               existing_nullable=True,
               existing_server_default=sa.text("'{}'::text[]"))
    op.alter_column('tasks', 'completed_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('tasks', 'reminder_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('tasks', 'due_time',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.execute("ALTER TABLE tasks ALTER COLUMN task_type DROP DEFAULT")
    op.alter_column('tasks', 'task_type',
               existing_type=sa.Enum('GENERAL', 'EMAIL', 'FOLLOW_UP', 'MEETING', name='tasktype', native_enum=False, length=50),
               type_=postgresql.ENUM('REPLY', 'SCHEDULE', 'REVIEW', 'FOLLOWUP', name='tasktype'),
               existing_postgresql_using='"task_type"::text::tasktype', nullable=False)
    op.execute("ALTER TABLE tasks ALTER COLUMN status DROP DEFAULT")
    op.alter_column('tasks', 'status',
               existing_type=sa.Enum('PENDING', 'TODO', 'IN_PROGRESS', 'DONE', 'CANCELLED', name='taskstatus', native_enum=False, length=50),
               type_=postgresql.ENUM('PENDING', 'IN_PROGRESS', 'COMPLETED', 'DISMISSED', name='taskstatus'),
               postgresql_using='"status"::text::taskstatus', nullable=True)
    op.alter_column('tasks', 'source_thread_id',
               existing_type=sa.VARCHAR(),
               nullable=False)
    op.alter_column('reminders', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('reminders', 'remind_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=False)
    op.drop_index(op.f('ix_oauth_state_tokens_state_token'), table_name='oauth_state_tokens')
    op.create_unique_constraint('oauth_state_tokens_state_token_key', 'oauth_state_tokens', ['state_token'])
    op.create_index('idx_oauth_state_token', 'oauth_state_tokens', ['state_token'], unique=False, postgresql_where='(consumed = false)')
    op.alter_column('oauth_state_tokens', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('oauth_state_tokens', 'consumed_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('oauth_state_tokens', 'expires_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=False)
    op.alter_column('oauth_state_tokens', 'provider',
               existing_type=sa.Enum('GMAIL', 'OUTLOOK', name='providertype'),
               type_=sa.VARCHAR(),
               existing_nullable=False)
    op.alter_column('messages', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('messages', 'sent_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=False)
    op.add_column('emails', sa.Column('body_text', sa.TEXT(), autoincrement=False, nullable=True))
    op.add_column('emails', sa.Column('to_addresses', sa.TEXT(), autoincrement=False, nullable=True))
    op.add_column('emails', sa.Column('from_address', sa.VARCHAR(), autoincrement=False, nullable=True))
    op.add_column('emails', sa.Column('is_read', sa.BOOLEAN(), autoincrement=False, nullable=True))
    op.add_column('emails', sa.Column('is_starred', sa.BOOLEAN(), autoincrement=False, nullable=True))
    op.add_column('emails', sa.Column('cc_addresses', sa.TEXT(), autoincrement=False, nullable=True))
    op.drop_index(op.f('ix_emails_sender'), table_name='emails')
    op.drop_index(op.f('ix_emails_received_at'), table_name='emails')
    op.drop_index(op.f('ix_emails_external_id'), table_name='emails')
    op.create_index('idx_emails_user_received', 'emails', ['user_id', sa.text('received_at DESC')], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_emails_thread', 'emails', ['thread_id', sa.text('received_at DESC')], unique=False)
    op.alter_column('emails', 'updated_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('emails', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('emails', 'deleted_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('emails', 'sent_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               nullable=False)
    op.alter_column('emails', 'received_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               nullable=True)
    op.alter_column('emails', 'references',
               existing_type=postgresql.ARRAY(sa.String()),
               type_=postgresql.ARRAY(sa.TEXT()),
               existing_nullable=True)
    op.alter_column('emails', 'snippet',
               existing_type=sa.String(),
               type_=sa.TEXT(),
               existing_nullable=True)
    op.alter_column('emails', 'subject',
               existing_type=sa.VARCHAR(),
               nullable=True)
    op.alter_column('emails', 'recipients',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=True)
    op.alter_column('emails', 'sender',
               existing_type=sa.VARCHAR(),
               nullable=True)
    op.add_column('drafts', sa.Column('is_sent', sa.BOOLEAN(), autoincrement=False, nullable=True))
    op.add_column('drafts', sa.Column('has_unresolved_placeholders', sa.BOOLEAN(), autoincrement=False, nullable=True))
    op.add_column('drafts', sa.Column('placeholders_json', sa.TEXT(), autoincrement=False, nullable=True))
    op.add_column('drafts', sa.Column('references_deadlines', sa.BOOLEAN(), autoincrement=False, nullable=True))
    op.add_column('drafts', sa.Column('references_attachments', sa.BOOLEAN(), autoincrement=False, nullable=True))
    op.add_column('drafts', sa.Column('content', sa.TEXT(), autoincrement=False, nullable=False))
    op.add_column('drafts', sa.Column('model_version', sa.VARCHAR(), autoincrement=False, nullable=True))
    op.drop_constraint(None, 'drafts', type_='foreignkey')
    op.create_index('idx_drafts_user_thread', 'drafts', ['user_id', 'thread_id'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_drafts_status', 'drafts', ['status', sa.text('created_at DESC')], unique=False)
    op.alter_column('drafts', 'updated_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('drafts', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('drafts', 'deleted_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('drafts', 'feedback',
               existing_type=sa.Enum('THUMBS_UP', 'THUMBS_DOWN', 'NEUTRAL', name='draftfeedback'),
               type_=sa.VARCHAR(),
               existing_nullable=True)
    op.alter_column('drafts', 'sent_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('drafts', 'copied_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('drafts', 'status',
               existing_type=sa.Enum('GENERATED', 'EDITED', 'SENT', 'DISCARDED', name='draftstatus'),
               type_=sa.VARCHAR(),
               nullable=True,
               existing_server_default=sa.text("'generated'::character varying"))
    op.alter_column('drafts', 'generation_model',
               existing_type=sa.VARCHAR(),
               nullable=True)
    op.execute("ALTER TABLE drafts ALTER COLUMN tone DROP DEFAULT")
    op.alter_column('drafts', 'tone',
               existing_type=sa.Enum('PROFESSIONAL', 'FRIENDLY', 'CONCISE', 'FORMAL', 'ASSERTIVE', 'CUSTOM', name='drafttone'),
               type_=postgresql.ENUM('BRIEF', 'NORMAL', 'FORMAL', name='tonetype'),
               postgresql_using='"tone"::text::tonetype', nullable=True)
    op.drop_column('drafts', 'user_edited')
    op.drop_column('drafts', 'body')
    op.drop_column('drafts', 'subject')
    op.alter_column('documents', 'indexed_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('credit_usage_daily', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.create_index('idx_credit_txns_user_created', 'credit_transactions', ['user_id', sa.text('created_at DESC')], unique=False)
    op.create_index('idx_credit_txns_type', 'credit_transactions', ['transaction_type', sa.text('created_at DESC')], unique=False)
    op.create_index('idx_credit_txns_operation', 'credit_transactions', ['operation_type'], unique=False, postgresql_where='(operation_type IS NOT NULL)')
    op.create_index('idx_credit_txns_flagged', 'credit_transactions', ['user_id'], unique=False, postgresql_where='(is_flagged = true)')
    op.alter_column('credit_transactions', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('credit_transactions', 'flag_reason',
               existing_type=sa.Text(),
               type_=sa.VARCHAR(),
               existing_nullable=True)
    op.alter_column('credit_transactions', 'user_agent',
               existing_type=sa.Text(),
               type_=sa.VARCHAR(),
               existing_nullable=True)
    op.alter_column('credit_transactions', 'expires_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('credit_transactions', 'status',
               existing_type=postgresql.ENUM('COMPLETED', 'RESERVED', 'CANCELLED', name='transactionstatus'),
               nullable=True)
    op.create_index('idx_credit_pricing_active', 'credit_pricing', ['operation_type'], unique=False, postgresql_where='(is_active = true)')
    op.alter_column('credit_pricing', 'updated_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('credit_pricing', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('credit_pricing', 'effective_from',
               existing_type=sa.DATE(),
               nullable=True)
    op.alter_column('credit_pricing', 'description',
               existing_type=sa.Text(),
               type_=sa.VARCHAR(),
               existing_nullable=True)
    op.drop_column('credit_packages', 'updated_at')
    op.drop_column('credit_packages', 'created_at')
    op.drop_column('credit_packages', 'description')
    op.drop_constraint('unique_user_provider_deleted', 'connected_accounts', type_='unique')
    op.create_index('idx_connected_accounts_user_provider', 'connected_accounts', ['user_id', 'provider'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_connected_accounts_sync', 'connected_accounts', ['sync_status'], unique=False, postgresql_where='(sync_enabled = true)')
    op.create_index('idx_connected_accounts_status', 'connected_accounts', ['status'], unique=False)
    op.alter_column('connected_accounts', 'updated_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('connected_accounts', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('connected_accounts', 'deleted_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('connected_accounts', 'last_watch_expires_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('connected_accounts', 'sync_status',
               existing_type=sa.VARCHAR(),
               nullable=True)
    op.alter_column('connected_accounts', 'last_sync_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('connected_accounts', 'status',
               existing_type=sa.VARCHAR(),
               nullable=True,
               existing_server_default=sa.text("'active'::character varying"))
    op.alter_column('connected_accounts', 'scopes',
               existing_type=sa.VARCHAR(),
               nullable=True)
    op.alter_column('connected_accounts', 'token_expires_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('connected_accounts', 'provider_email',
               existing_type=sa.VARCHAR(),
               nullable=True)
    op.alter_column('connected_accounts', 'provider_user_id',
               existing_type=sa.VARCHAR(),
               nullable=True)
    op.execute("ALTER TABLE connected_accounts ALTER COLUMN provider DROP DEFAULT")
    op.alter_column('connected_accounts', 'provider',
               existing_type=sa.Enum('GMAIL', 'OUTLOOK', name='providertype', native_enum=False, length=50),
               type_=postgresql.ENUM('GMAIL', 'OUTLOOK', name='providertype'),
               existing_postgresql_using='"provider"::text::providertype', nullable=False)
    op.add_column('calendar_suggestions', sa.Column('extracted_from', sa.TEXT(), autoincrement=False, nullable=True))
    op.add_column('calendar_suggestions', sa.Column('is_accepted', sa.BOOLEAN(), autoincrement=False, nullable=True))
    op.drop_constraint(None, 'calendar_suggestions', type_='foreignkey')
    op.drop_index(op.f('ix_calendar_suggestions_email_id'), table_name='calendar_suggestions')
    op.create_index('idx_calendar_user_status', 'calendar_suggestions', ['user_id', 'status'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_calendar_thread', 'calendar_suggestions', ['thread_id'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_calendar_date', 'calendar_suggestions', ['suggested_date'], unique=False, postgresql_where="((status)::text = 'suggested'::text)")
    op.alter_column('calendar_suggestions', 'updated_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('calendar_suggestions', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('calendar_suggestions', 'deleted_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('calendar_suggestions', 'dismissed_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('calendar_suggestions', 'accepted_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('calendar_suggestions', 'status',
               existing_type=sa.Enum('SUGGESTED', 'ACCEPTED', 'DISMISSED', 'EXPIRED', name='calendarsuggestionstatus'),
               type_=sa.VARCHAR(),
               nullable=True,
               existing_server_default=sa.text("'suggested'::character varying"))
    op.alter_column('calendar_suggestions', 'confidence_score',
               existing_type=sa.INTEGER(),
               nullable=True,
               existing_server_default=sa.text('0'))
    op.alter_column('calendar_suggestions', 'participants',
               existing_type=postgresql.ARRAY(sa.String()),
               type_=postgresql.ARRAY(sa.TEXT()),
               existing_nullable=True,
               existing_server_default=sa.text("'{}'::text[]"))
    op.alter_column('calendar_suggestions', 'suggested_end_time',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('calendar_suggestions', 'suggested_time',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('calendar_suggestions', 'event_type',
               existing_type=sa.VARCHAR(),
               nullable=True,
               existing_server_default=sa.text("'meeting'::character varying"))
    op.alter_column('calendar_suggestions', 'email_id',
               existing_type=sa.VARCHAR(),
               nullable=True)
    op.drop_column('calendar_suggestions', 'is_recurring')
    op.add_column('attachments', sa.Column('summary', sa.VARCHAR(), autoincrement=False, nullable=True))
    op.add_column('attachments', sa.Column('mime_type', sa.VARCHAR(), autoincrement=False, nullable=False))
    op.add_column('attachments', sa.Column('original_filename', sa.VARCHAR(), autoincrement=False, nullable=True))
    op.add_column('attachments', sa.Column('key_points', sa.VARCHAR(), autoincrement=False, nullable=True))
    op.add_column('attachments', sa.Column('document_type', sa.VARCHAR(), autoincrement=False, nullable=True))
    op.add_column('attachments', sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False))
    op.drop_constraint(None, 'attachments', type_='foreignkey')
    op.create_foreign_key('attachments_message_id_fkey', 'attachments', 'messages', ['email_id'], ['id'])
    op.create_foreign_key('attachments_user_id_fkey', 'attachments', 'users', ['user_id'], ['id'])
    op.drop_constraint('unique_email_attachment_hash', 'attachments', type_='unique')
    op.drop_index(op.f('ix_attachments_sha256_hash'), table_name='attachments')
    op.drop_index(op.f('ix_attachments_email_id'), table_name='attachments')
    op.create_index('ix_attachments_user_id', 'attachments', ['user_id'], unique=False)
    op.create_index('ix_attachments_message_id', 'attachments', ['email_id'], unique=False)
    op.create_index('idx_attachments_user', 'attachments', ['user_id'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_attachments_status', 'attachments', ['status'], unique=False, postgresql_where="((status)::text = ANY ((ARRAY['pending'::character varying, 'processing'::character varying])::text[]))")
    op.create_index('idx_attachments_hash', 'attachments', ['sha256_hash'], unique=False, postgresql_where='(sha256_hash IS NOT NULL)')
    op.create_index('idx_attachments_email', 'attachments', ['email_id'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.alter_column('attachments', 'updated_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('attachments', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('attachments', 'deleted_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('attachments', 'processed_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('attachments', 'downloaded_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=True)
    op.alter_column('attachments', 'extraction_confidence',
               existing_type=sa.Float(),
               type_=sa.INTEGER(),
               existing_nullable=True)
    op.alter_column('attachments', 'status',
               existing_type=sa.Enum('PENDING', 'DOWNLOADING', 'PROCESSING', 'INDEXED', 'FAILED', 'SKIPPED', 'QUARANTINED', name='attachmentstatus'),
               type_=sa.VARCHAR(),
               nullable=True,
               existing_server_default=sa.text("'pending'::character varying"))
    op.alter_column('attachments', 'storage_path',
               existing_type=sa.Text(),
               type_=sa.VARCHAR(),
               existing_nullable=True)
    op.alter_column('attachments', 'storage_provider',
               existing_type=sa.Enum('S3', 'R2', 'GCS', name='storageprovider'),
               type_=sa.VARCHAR(),
               nullable=True,
               existing_server_default=sa.text("'s3'::character varying"))
    op.alter_column('attachments', 'sha256_hash',
               existing_type=sa.VARCHAR(),
               nullable=True)
    op.alter_column('attachments', 'size_bytes',
               existing_type=sa.BigInteger(),
               type_=sa.INTEGER(),
               nullable=True)
    op.alter_column('attachments', 'content_type',
               existing_type=sa.VARCHAR(),
               nullable=True)
    op.alter_column('attachments', 'filename_sanitized',
               existing_type=sa.VARCHAR(),
               nullable=True)
    op.create_table('invoices',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('stripe_invoice_id', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('stripe_payment_intent_id', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.Column('amount_cents', sa.INTEGER(), autoincrement=False, nullable=False),
    sa.Column('currency', sa.VARCHAR(length=3), server_default=sa.text("'usd'::character varying"), autoincrement=False, nullable=True),
    sa.Column('status', sa.VARCHAR(), server_default=sa.text("'draft'::character varying"), autoincrement=False, nullable=True),
    sa.Column('invoice_pdf_url', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('paid_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('metadata_json', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='invoices_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='invoices_pkey'),
    sa.UniqueConstraint('stripe_invoice_id', name='invoices_stripe_invoice_id_key')
    )
    op.create_index('idx_invoices_user_created', 'invoices', ['user_id', sa.text('created_at DESC')], unique=False)
    op.create_index('idx_invoices_status', 'invoices', ['status'], unique=False)
    op.create_table('api_keys',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('name', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('key_prefix', sa.VARCHAR(length=20), autoincrement=False, nullable=False),
    sa.Column('key_hash', sa.VARCHAR(length=64), autoincrement=False, nullable=False),
    sa.Column('scopes', postgresql.ARRAY(sa.TEXT()), autoincrement=False, nullable=False),
    sa.Column('rate_limit_per_hour', sa.INTEGER(), server_default=sa.text('1000'), autoincrement=False, nullable=True),
    sa.Column('last_used_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('last_used_ip', sa.VARCHAR(length=45), autoincrement=False, nullable=True),
    sa.Column('usage_count', sa.BIGINT(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('expires_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('is_active', sa.BOOLEAN(), server_default=sa.text('true'), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='api_keys_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='api_keys_pkey'),
    sa.UniqueConstraint('key_hash', name='api_keys_key_hash_key')
    )
    op.create_index('idx_api_keys_user', 'api_keys', ['user_id'], unique=False, postgresql_where='(is_active = true)')
    op.create_index('idx_api_keys_hash', 'api_keys', ['key_hash'], unique=False)
    op.create_table('ai_usage_daily_summary',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('date', sa.DATE(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('operation_type', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('total_operations', sa.INTEGER(), autoincrement=False, nullable=False),
    sa.Column('total_tokens', sa.BIGINT(), autoincrement=False, nullable=False),
    sa.Column('total_cost_cents', sa.BIGINT(), autoincrement=False, nullable=False),
    sa.Column('total_credits_charged', sa.BIGINT(), autoincrement=False, nullable=True),
    sa.Column('avg_latency_ms', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('cache_hit_rate', sa.NUMERIC(precision=5, scale=2), autoincrement=False, nullable=True),
    sa.Column('error_rate', sa.NUMERIC(precision=5, scale=2), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='ai_usage_daily_summary_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='ai_usage_daily_summary_pkey'),
    sa.UniqueConstraint('date', 'user_id', 'operation_type', name='unique_daily_usage')
    )
    op.create_index('idx_ai_summary_date_user', 'ai_usage_daily_summary', [sa.text('date DESC'), 'user_id'], unique=False)
    op.create_index('idx_ai_summary_date_op', 'ai_usage_daily_summary', [sa.text('date DESC'), 'operation_type'], unique=False)
    op.create_table('consent_records',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('consent_type', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('version', sa.VARCHAR(length=20), autoincrement=False, nullable=False),
    sa.Column('consented', sa.BOOLEAN(), autoincrement=False, nullable=False),
    sa.Column('consent_method', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('ip_address', sa.VARCHAR(length=45), autoincrement=False, nullable=False),
    sa.Column('user_agent', sa.TEXT(), autoincrement=False, nullable=False),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='consent_records_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='consent_records_pkey')
    )
    op.create_index('idx_consent_user_type', 'consent_records', ['user_id', 'consent_type', sa.text('created_at DESC')], unique=False)
    op.create_table('user_analytics_daily',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('date', sa.DATE(), autoincrement=False, nullable=False),
    sa.Column('emails_received', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('emails_sent', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('threads_processed', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('time_saved_minutes', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='user_analytics_daily_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='user_analytics_daily_pkey'),
    sa.UniqueConstraint('user_id', 'date', name='uq_user_analytics_date')
    )
    op.create_index('idx_user_analytics_date', 'user_analytics_daily', ['date'], unique=False)
    op.create_table('subscriptions',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('workspace_id', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('stripe_customer_id', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('stripe_subscription_id', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('stripe_price_id', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('plan', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('status', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('current_period_start', postgresql.TIMESTAMP(), autoincrement=False, nullable=False),
    sa.Column('current_period_end', postgresql.TIMESTAMP(), autoincrement=False, nullable=False),
    sa.Column('cancel_at_period_end', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('canceled_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('trial_start', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('trial_end', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('metadata_json', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='subscriptions_user_id_fkey'),
    sa.ForeignKeyConstraint(['workspace_id'], ['workspaces.id'], name='subscriptions_workspace_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='subscriptions_pkey'),
    sa.UniqueConstraint('stripe_subscription_id', name='subscriptions_stripe_subscription_id_key'),
    sa.UniqueConstraint('user_id', name='subscriptions_user_id_key')
    )
    op.create_index('idx_subscriptions_user', 'subscriptions', ['user_id'], unique=False)
    op.create_index('idx_subscriptions_stripe_customer', 'subscriptions', ['stripe_customer_id'], unique=False)
    op.create_index('idx_subscriptions_status', 'subscriptions', ['status'], unique=False)
    op.create_table('email_templates',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('workspace_id', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('name', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('description', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('subject', sa.VARCHAR(length=500), autoincrement=False, nullable=True),
    sa.Column('body', sa.TEXT(), autoincrement=False, nullable=False),
    sa.Column('variables', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'[]'::jsonb"), autoincrement=False, nullable=True),
    sa.Column('category', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.Column('is_public', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('usage_count', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('last_used_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('deleted_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='email_templates_user_id_fkey'),
    sa.ForeignKeyConstraint(['workspace_id'], ['workspaces.id'], name='email_templates_workspace_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='email_templates_pkey')
    )
    op.create_index('idx_templates_workspace', 'email_templates', ['workspace_id'], unique=False, postgresql_where='((is_public = true) AND (deleted_at IS NULL))')
    op.create_index('idx_templates_user', 'email_templates', ['user_id'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_table('saved_searches',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('name', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('query_text', sa.TEXT(), autoincrement=False, nullable=False),
    sa.Column('filters', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=True),
    sa.Column('is_smart_folder', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('notification_enabled', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('last_used_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='saved_searches_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='saved_searches_pkey')
    )
    op.create_index('idx_saved_searches_user', 'saved_searches', ['user_id', sa.text('created_at DESC')], unique=False)
    op.create_table('user_feature_overrides',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('feature_flag_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('override_value', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=False),
    sa.Column('reason', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('set_by_admin_id', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('expires_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['feature_flag_id'], ['feature_flags.id'], name='user_feature_overrides_feature_flag_id_fkey'),
    sa.ForeignKeyConstraint(['set_by_admin_id'], ['admin_users.id'], name='user_feature_overrides_set_by_admin_id_fkey'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='user_feature_overrides_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='user_feature_overrides_pkey'),
    sa.UniqueConstraint('user_id', 'feature_flag_id', name='uq_user_feature_override')
    )
    op.create_index('idx_feature_overrides_user_flag', 'user_feature_overrides', ['user_id', 'feature_flag_id'], unique=False)
    op.create_table('user_activity_logs',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('action_type', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('description', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('metadata_json', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=True),
    sa.Column('ip_address', sa.VARCHAR(length=45), autoincrement=False, nullable=True),
    sa.Column('user_agent', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='user_activity_logs_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='user_activity_logs_pkey')
    )
    op.create_index('idx_activity_logs_user_created', 'user_activity_logs', ['user_id', sa.text('created_at DESC')], unique=False)
    op.create_table('rate_limit_violations',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('ip_address', sa.VARCHAR(length=45), autoincrement=False, nullable=False),
    sa.Column('endpoint', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('limit_type', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('limit_value', sa.INTEGER(), autoincrement=False, nullable=False),
    sa.Column('actual_value', sa.INTEGER(), autoincrement=False, nullable=False),
    sa.Column('blocked', sa.BOOLEAN(), server_default=sa.text('true'), autoincrement=False, nullable=True),
    sa.Column('user_agent', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='rate_limit_violations_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='rate_limit_violations_pkey')
    )
    op.create_index('idx_rate_violations_user', 'rate_limit_violations', ['user_id', sa.text('created_at DESC')], unique=False)
    op.create_index('idx_rate_violations_ip', 'rate_limit_violations', ['ip_address', sa.text('created_at DESC')], unique=False)
    op.create_table('follow_ups',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('thread_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('last_sent_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=False),
    sa.Column('days_waiting', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('reminded', sa.BOOLEAN(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('email_id', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('expected_reply_by', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('status', sa.VARCHAR(), server_default=sa.text("'waiting'::character varying"), autoincrement=False, nullable=True),
    sa.Column('snoozed_until', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('reply_received_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('auto_detected', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('detection_confidence', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('metadata_json', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=True),
    sa.Column('deleted_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['thread_id'], ['threads.id'], name='waiting_for_thread_id_fkey', ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='waiting_for_user_id_fkey', ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name='waiting_for_pkey'),
    sa.UniqueConstraint('thread_id', 'user_id', name='unique_thread_user_waiting')
    )
    op.create_index('ix_waiting_for_user_id', 'follow_ups', ['user_id'], unique=False)
    op.create_index('ix_waiting_for_thread_id', 'follow_ups', ['thread_id'], unique=False)
    op.create_index('idx_followups_user_status', 'follow_ups', ['user_id', 'status'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_followups_thread', 'follow_ups', ['thread_id'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_followups_overdue', 'follow_ups', ['expected_reply_by'], unique=False, postgresql_where="((status)::text = 'waiting'::text)")
    op.create_table('ai_processing_queue',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('operation_type', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('entity_type', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('entity_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('priority', sa.INTEGER(), server_default=sa.text('5'), autoincrement=False, nullable=True),
    sa.Column('status', sa.VARCHAR(), server_default=sa.text("'pending'::character varying"), autoincrement=False, nullable=True),
    sa.Column('attempts', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('max_attempts', sa.INTEGER(), server_default=sa.text('3'), autoincrement=False, nullable=True),
    sa.Column('reserved_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('reserved_by_worker', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('reservation_expires_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('completed_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('failed_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('error_message', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('input_context', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('result', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('metadata_json', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='ai_processing_queue_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='ai_processing_queue_pkey')
    )
    op.create_index('idx_ai_queue_user_entity', 'ai_processing_queue', ['user_id', 'entity_type', 'entity_id'], unique=False)
    op.create_index('idx_ai_queue_reserved', 'ai_processing_queue', ['reservation_expires_at'], unique=False, postgresql_where="((status)::text = 'reserved'::text)")
    op.create_index('idx_ai_queue_pending', 'ai_processing_queue', ['priority', 'created_at'], unique=False, postgresql_where="((status)::text = 'pending'::text)")
    op.create_table('integrations',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('workspace_id', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('integration_type', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('name', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('status', sa.VARCHAR(), server_default=sa.text("'active'::character varying"), autoincrement=False, nullable=True),
    sa.Column('config', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=False),
    sa.Column('credentials_encrypted', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('last_triggered_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('trigger_count', sa.BIGINT(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('error_count', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('last_error', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('last_error_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('metadata_json', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=True),
    sa.Column('deleted_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='integrations_user_id_fkey'),
    sa.ForeignKeyConstraint(['workspace_id'], ['workspaces.id'], name='integrations_workspace_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='integrations_pkey'),
    postgresql_ignore_search_path=False
    )
    op.create_index('idx_integrations_workspace', 'integrations', ['workspace_id'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_index('idx_integrations_user_type', 'integrations', ['user_id', 'integration_type'], unique=False, postgresql_where='(deleted_at IS NULL)')
    op.create_table('data_retention_policies',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('entity_type', sa.VARCHAR(length=100), autoincrement=False, nullable=False),
    sa.Column('retention_days', sa.INTEGER(), autoincrement=False, nullable=False),
    sa.Column('applies_to_deleted', sa.BOOLEAN(), server_default=sa.text('true'), autoincrement=False, nullable=True),
    sa.Column('applies_to_active', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('user_configurable', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('is_active', sa.BOOLEAN(), server_default=sa.text('true'), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.PrimaryKeyConstraint('id', name='data_retention_policies_pkey')
    )
    op.create_table('feature_flags',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('flag_key', sa.VARCHAR(length=100), autoincrement=False, nullable=False),
    sa.Column('name', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('description', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('flag_type', sa.VARCHAR(), server_default=sa.text("'boolean'::character varying"), autoincrement=False, nullable=True),
    sa.Column('default_value', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=False),
    sa.Column('is_active', sa.BOOLEAN(), server_default=sa.text('true'), autoincrement=False, nullable=True),
    sa.Column('rollout_percentage', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('targeting_rules', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'[]'::jsonb"), autoincrement=False, nullable=True),
    sa.Column('created_by_admin_id', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['created_by_admin_id'], ['admin_users.id'], name='feature_flags_created_by_admin_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='feature_flags_pkey'),
    sa.UniqueConstraint('flag_key', name='feature_flags_flag_key_key')
    )
    op.create_index('idx_feature_flags_key', 'feature_flags', ['flag_key'], unique=False, postgresql_where='(is_active = true)')
    op.create_table('ab_experiment_assignments',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('experiment_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('variant_key', sa.VARCHAR(length=50), autoincrement=False, nullable=False),
    sa.Column('assigned_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['experiment_id'], ['ab_experiments.id'], name='ab_experiment_assignments_experiment_id_fkey'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='ab_experiment_assignments_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='ab_experiment_assignments_pkey'),
    sa.UniqueConstraint('experiment_id', 'user_id', name='uq_experiment_user_assignment')
    )
    op.create_index('idx_experiment_assignments_user', 'ab_experiment_assignments', ['user_id', 'experiment_id'], unique=False)
    op.create_index('idx_experiment_assignments_experiment', 'ab_experiment_assignments', ['experiment_id', 'variant_key'], unique=False)
    op.create_table('health_checks',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('component', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('status', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('response_time_ms', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('error_message', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('checked_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.Column('metadata_json', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=True),
    sa.PrimaryKeyConstraint('id', name='health_checks_pkey')
    )
    op.create_index('idx_health_checks_component_time', 'health_checks', ['component', sa.text('checked_at DESC')], unique=False)
    op.create_table('integration_logs',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('integration_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('trigger_type', sa.VARCHAR(length=100), autoincrement=False, nullable=False),
    sa.Column('payload', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=False),
    sa.Column('response', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('status', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('error_message', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('latency_ms', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['integration_id'], ['integrations.id'], name='integration_logs_integration_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='integration_logs_pkey')
    )
    op.create_index('idx_integration_logs_created', 'integration_logs', ['integration_id', sa.text('created_at DESC')], unique=False)
    op.create_table('admin_users',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('role', sa.VARCHAR(), server_default=sa.text("'readonly'::character varying"), autoincrement=False, nullable=True),
    sa.Column('permissions', postgresql.ARRAY(sa.TEXT()), server_default=sa.text("'{}'::text[]"), autoincrement=False, nullable=True),
    sa.Column('can_impersonate', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('can_adjust_credits', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('can_view_analytics', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('can_manage_users', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('can_manage_billing', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('last_admin_action_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('is_active', sa.BOOLEAN(), server_default=sa.text('true'), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='admin_users_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='admin_users_pkey'),
    sa.UniqueConstraint('user_id', name='admin_users_user_id_key'),
    postgresql_ignore_search_path=False
    )
    op.create_index('idx_admin_users_user', 'admin_users', ['user_id'], unique=False, postgresql_where='(is_active = true)')
    op.create_index('idx_admin_users_role', 'admin_users', ['role'], unique=False)
    op.create_table('notifications',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('type', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('title', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('body', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('action_url', sa.VARCHAR(length=500), autoincrement=False, nullable=True),
    sa.Column('action_text', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.Column('related_entity_type', sa.VARCHAR(length=50), autoincrement=False, nullable=True),
    sa.Column('related_entity_id', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('priority', sa.VARCHAR(), server_default=sa.text("'normal'::character varying"), autoincrement=False, nullable=True),
    sa.Column('is_read', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('read_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('is_dismissed', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('dismissed_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('expires_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('metadata_json', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='notifications_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='notifications_pkey')
    )
    op.create_index('idx_notifications_user_unread', 'notifications', ['user_id', sa.text('created_at DESC')], unique=False, postgresql_where='(is_read = false)')
    op.create_index('idx_notifications_expires', 'notifications', ['expires_at'], unique=False, postgresql_where='(expires_at IS NOT NULL)')
    op.create_table('job_queue',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('job_type', sa.VARCHAR(length=100), autoincrement=False, nullable=False),
    sa.Column('priority', sa.INTEGER(), server_default=sa.text('5'), autoincrement=False, nullable=True),
    sa.Column('payload', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=False),
    sa.Column('status', sa.VARCHAR(), server_default=sa.text("'pending'::character varying"), autoincrement=False, nullable=True),
    sa.Column('attempts', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('max_attempts', sa.INTEGER(), server_default=sa.text('3'), autoincrement=False, nullable=True),
    sa.Column('reserved_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('reserved_by_worker', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.Column('reservation_expires_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('started_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('completed_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('failed_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('error_message', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('scheduled_for', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.PrimaryKeyConstraint('id', name='job_queue_pkey')
    )
    op.create_index('idx_jobs_type_status', 'job_queue', ['job_type', 'status', sa.text('created_at DESC')], unique=False)
    op.create_index('idx_jobs_reserved_expires', 'job_queue', ['reservation_expires_at'], unique=False, postgresql_where="((status)::text = 'reserved'::text)")
    op.create_index('idx_jobs_pending', 'job_queue', ['priority', 'created_at'], unique=False, postgresql_where="((status)::text = 'pending'::text)")
    op.create_table('gdpr_requests',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('request_type', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('status', sa.VARCHAR(), server_default=sa.text("'pending'::character varying"), autoincrement=False, nullable=True),
    sa.Column('requested_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.Column('completed_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('export_file_url', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('export_expires_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('deletion_confirmed', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('deletion_completed_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('admin_notes', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('metadata_json', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='gdpr_requests_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='gdpr_requests_pkey')
    )
    op.create_index('idx_gdpr_requests_user_status', 'gdpr_requests', ['user_id', 'status'], unique=False)
    op.create_index('idx_gdpr_requests_pending', 'gdpr_requests', ['requested_at'], unique=False, postgresql_where="((status)::text = 'pending'::text)")
    op.create_table('abuse_reports',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('reporter_user_id', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('reported_user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('report_type', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('severity', sa.VARCHAR(), server_default=sa.text("'low'::character varying"), autoincrement=False, nullable=True),
    sa.Column('description', sa.TEXT(), autoincrement=False, nullable=False),
    sa.Column('evidence', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=True),
    sa.Column('status', sa.VARCHAR(), server_default=sa.text("'pending'::character varying"), autoincrement=False, nullable=True),
    sa.Column('assigned_to_admin_id', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('resolution_notes', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('resolved_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('auto_detected', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('detection_rule', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['assigned_to_admin_id'], ['admin_users.id'], name='abuse_reports_assigned_to_admin_id_fkey'),
    sa.ForeignKeyConstraint(['reported_user_id'], ['users.id'], name='abuse_reports_reported_user_id_fkey'),
    sa.ForeignKeyConstraint(['reporter_user_id'], ['users.id'], name='abuse_reports_reporter_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='abuse_reports_pkey')
    )
    op.create_index('idx_abuse_reports_status', 'abuse_reports', ['status', sa.text('created_at DESC')], unique=False)
    op.create_index('idx_abuse_reports_reported_user', 'abuse_reports', ['reported_user_id'], unique=False)
    op.create_index('idx_abuse_reports_assigned', 'abuse_reports', ['assigned_to_admin_id'], unique=False, postgresql_where="((status)::text = 'investigating'::text)")
    op.create_table('ab_experiments',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('experiment_key', sa.VARCHAR(length=100), autoincrement=False, nullable=False),
    sa.Column('name', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('description', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('hypothesis', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('variants', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=False),
    sa.Column('traffic_allocation', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=False),
    sa.Column('start_date', postgresql.TIMESTAMP(), autoincrement=False, nullable=False),
    sa.Column('end_date', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('status', sa.VARCHAR(), server_default=sa.text("'draft'::character varying"), autoincrement=False, nullable=True),
    sa.Column('winning_variant', sa.VARCHAR(length=50), autoincrement=False, nullable=True),
    sa.Column('created_by_admin_id', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['created_by_admin_id'], ['admin_users.id'], name='ab_experiments_created_by_admin_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='ab_experiments_pkey'),
    sa.UniqueConstraint('experiment_key', name='ab_experiments_experiment_key_key')
    )
    op.create_table('rule_execution_log',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('rule_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('thread_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('email_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('conditions_matched', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=False),
    sa.Column('actions_executed', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=False),
    sa.Column('success', sa.BOOLEAN(), autoincrement=False, nullable=False),
    sa.Column('error_message', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['email_id'], ['emails.id'], name='rule_execution_log_email_id_fkey'),
    sa.ForeignKeyConstraint(['rule_id'], ['email_rules.id'], name='rule_execution_log_rule_id_fkey'),
    sa.ForeignKeyConstraint(['thread_id'], ['threads.id'], name='rule_execution_log_thread_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='rule_execution_log_pkey')
    )
    op.create_index('idx_rule_execution_rule', 'rule_execution_log', ['rule_id', sa.text('created_at DESC')], unique=False)
    op.create_table('email_rules',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('name', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('description', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('priority', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('is_active', sa.BOOLEAN(), server_default=sa.text('true'), autoincrement=False, nullable=True),
    sa.Column('conditions', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=False),
    sa.Column('actions', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=False),
    sa.Column('match_all_conditions', sa.BOOLEAN(), server_default=sa.text('true'), autoincrement=False, nullable=True),
    sa.Column('apply_to_existing', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('times_triggered', sa.BIGINT(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('last_triggered_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='email_rules_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='email_rules_pkey')
    )
    op.create_index('idx_email_rules_user_priority', 'email_rules', ['user_id', 'priority'], unique=False, postgresql_where='(is_active = true)')
    op.create_table('search_queries',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('query_text', sa.TEXT(), autoincrement=False, nullable=False),
    sa.Column('search_type', sa.VARCHAR(), server_default=sa.text("'keyword'::character varying"), autoincrement=False, nullable=True),
    sa.Column('filters_applied', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=True),
    sa.Column('results_count', sa.INTEGER(), autoincrement=False, nullable=False),
    sa.Column('clicked_result_id', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('latency_ms', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='search_queries_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='search_queries_pkey')
    )
    op.create_index('idx_search_queries_user_created', 'search_queries', ['user_id', sa.text('created_at DESC')], unique=False)
    op.create_index('idx_search_queries_text', 'search_queries', [sa.text("to_tsvector('english'::regconfig, query_text)")], unique=False, postgresql_using='gin')
    op.create_table('ai_usage_logs',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('operation_type', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('provider', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('model_name', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('tokens_input', sa.INTEGER(), autoincrement=False, nullable=False),
    sa.Column('tokens_output', sa.INTEGER(), autoincrement=False, nullable=False),
    sa.Column('tokens_total', sa.INTEGER(), autoincrement=False, nullable=False),
    sa.Column('cost_cents', sa.INTEGER(), autoincrement=False, nullable=False),
    sa.Column('credits_charged', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('latency_ms', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('cache_hit', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('related_entity_type', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('related_entity_id', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('request_id', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('error_occurred', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('error_type', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('metadata_json', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='ai_usage_logs_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='ai_usage_logs_pkey')
    )
    op.create_index('idx_ai_logs_user_created', 'ai_usage_logs', ['user_id', sa.text('created_at DESC')], unique=False)
    op.create_index('idx_ai_logs_operation', 'ai_usage_logs', ['operation_type', sa.text('created_at DESC')], unique=False)
    op.create_index('idx_ai_logs_cost', 'ai_usage_logs', ['created_at'], unique=False, postgresql_where='(cost_cents > 0)')
    op.create_table('scheduled_jobs',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('job_name', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('job_type', sa.VARCHAR(length=100), autoincrement=False, nullable=False),
    sa.Column('schedule_expression', sa.VARCHAR(length=100), autoincrement=False, nullable=False),
    sa.Column('payload_template', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=False),
    sa.Column('is_active', sa.BOOLEAN(), server_default=sa.text('true'), autoincrement=False, nullable=True),
    sa.Column('last_run_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('next_run_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=False),
    sa.Column('run_count', sa.BIGINT(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('failure_count', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('last_error', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.PrimaryKeyConstraint('id', name='scheduled_jobs_pkey'),
    sa.UniqueConstraint('job_name', name='scheduled_jobs_job_name_key')
    )
    op.create_index('idx_scheduled_jobs_next_run', 'scheduled_jobs', ['next_run_at'], unique=False, postgresql_where='(is_active = true)')
    op.create_table('system_analytics_daily',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('date', sa.DATE(), autoincrement=False, nullable=False),
    sa.Column('total_users', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('active_users_daily', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('total_emails_processed', sa.BIGINT(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('total_api_calls', sa.BIGINT(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('revenue_cents', sa.BIGINT(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.PrimaryKeyConstraint('id', name='system_analytics_daily_pkey'),
    sa.UniqueConstraint('date', name='system_analytics_daily_date_key')
    )
    op.create_table('notification_preferences',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('email_enabled', sa.BOOLEAN(), server_default=sa.text('true'), autoincrement=False, nullable=True),
    sa.Column('push_enabled', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('in_app_enabled', sa.BOOLEAN(), server_default=sa.text('true'), autoincrement=False, nullable=True),
    sa.Column('channels', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=True),
    sa.Column('quiet_hours_start', postgresql.TIME(), autoincrement=False, nullable=True),
    sa.Column('quiet_hours_end', postgresql.TIME(), autoincrement=False, nullable=True),
    sa.Column('quiet_hours_timezone', sa.VARCHAR(length=50), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='notification_preferences_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='notification_preferences_pkey'),
    sa.UniqueConstraint('user_id', name='notification_preferences_user_id_key')
    )
    op.create_table('error_logs',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('error_type', sa.VARCHAR(length=100), autoincrement=False, nullable=False),
    sa.Column('error_message', sa.TEXT(), autoincrement=False, nullable=False),
    sa.Column('stack_trace', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('severity', sa.VARCHAR(), server_default=sa.text("'error'::character varying"), autoincrement=False, nullable=True),
    sa.Column('user_id', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('request_path', sa.VARCHAR(length=500), autoincrement=False, nullable=True),
    sa.Column('request_method', sa.VARCHAR(length=10), autoincrement=False, nullable=True),
    sa.Column('ip_address', sa.VARCHAR(length=45), autoincrement=False, nullable=True),
    sa.Column('user_agent', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('context', postgresql.JSONB(astext_type=sa.Text()), server_default=sa.text("'{}'::jsonb"), autoincrement=False, nullable=True),
    sa.Column('resolved', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('resolved_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name='error_logs_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='error_logs_pkey')
    )
    op.create_index('idx_error_logs_user', 'error_logs', ['user_id'], unique=False, postgresql_where='(user_id IS NOT NULL)')
    op.create_index('idx_error_logs_unresolved', 'error_logs', [sa.text('created_at DESC')], unique=False, postgresql_where='(resolved = false)')
    op.create_index('idx_error_logs_type_created', 'error_logs', ['error_type', sa.text('created_at DESC')], unique=False)
    op.create_index('idx_error_logs_severity', 'error_logs', ['severity', sa.text('created_at DESC')], unique=False, postgresql_where="((severity)::text = ANY ((ARRAY['error'::character varying, 'critical'::character varying])::text[]))")
    op.create_table('admin_audit_log',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('admin_user_id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('action_type', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('target_user_id', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('action_details', sa.TEXT(), autoincrement=False, nullable=False),
    sa.Column('before_state', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('after_state', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('ip_address', sa.VARCHAR(length=45), autoincrement=False, nullable=False),
    sa.Column('user_agent', sa.TEXT(), autoincrement=False, nullable=False),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['admin_user_id'], ['admin_users.id'], name='admin_audit_log_admin_user_id_fkey'),
    sa.ForeignKeyConstraint(['target_user_id'], ['users.id'], name='admin_audit_log_target_user_id_fkey'),
    sa.PrimaryKeyConstraint('id', name='admin_audit_log_pkey')
    )
    op.create_index('idx_admin_audit_target_created', 'admin_audit_log', ['target_user_id', sa.text('created_at DESC')], unique=False)
    op.create_index('idx_admin_audit_admin_created', 'admin_audit_log', ['admin_user_id', sa.text('created_at DESC')], unique=False)
    op.create_index('idx_admin_audit_action_created', 'admin_audit_log', ['action_type', sa.text('created_at DESC')], unique=False)
    op.create_table('translations',
    sa.Column('id', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('key', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('locale', sa.VARCHAR(length=10), autoincrement=False, nullable=False),
    sa.Column('value', sa.TEXT(), autoincrement=False, nullable=False),
    sa.Column('context', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.Column('is_verified', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.PrimaryKeyConstraint('id', name='translations_pkey'),
    sa.UniqueConstraint('key', 'locale', name='uq_translation_key_locale')
    )
    op.create_index('idx_translations_key_locale', 'translations', ['key', 'locale'], unique=False)
    # ### end Alembic commands ###
